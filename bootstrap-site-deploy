# last modified 2019-09-03

if ! git rev-parse --is-inside-work-tree; then
  echo Not in a Git repo; exit
fi

REPOTOPDIR=$(git rev-parse --show-toplevel)

if test x$(basename $REPOTOPDIR) != xcurriculum; then
  echo Not in curriculum repo; exit
fi

cd $REPOTOPDIR

ORIGBRANCH=$(git rev-parse --abbrev-ref HEAD)

if test x$ORIGBRANCH != xgh-pages; then
  rm -fr distribution asciidoctor.css index.html README.html
  if ! git switch gh-pages; then
    echo Could not switch to gh-pages branch; exit
  fi
fi

git pull

if test ! -d distribution; then
  echo No distribution directory found; exit
fi

DEPLOYDIR=/gpfs/main/authen/sys/web/cs/web/sites/bootstrapworld.org/preview

if test ! -d $DEPLOYDIR; then
  DEPLOYDIR=~/tmp
fi

rm -fr $DEPLOYDIR/distribution

cp -prH distribution $DEPLOYDIR

if test x$ORIGBRANCH != xgh-pages; then
  git switch $ORIGBRANCH
fi

cd $DEPLOYDIR

find distribution -type d | xargs chmod g+r,o+rx

cd distribution

find . -type f | xargs chmod g+r,o+r

cd ..

rm -fr curriculum

mv distribution curriculum
