# last modified 2019-10-29

if ! git rev-parse --is-inside-work-tree; then
  echo Not in a Git repo; exit
fi

REPO_TOPDIR=$(git rev-parse --show-toplevel)

if test "$(basename $REPO_TOPDIR)" != curriculum; then
  echo Not in curriculum repo; exit
fi

cd $REPO_TOPDIR

ORIG_BRANCH=$(git rev-parse --abbrev-ref HEAD)

if test "$ORIG_BRANCH" != gh-pages; then
  rm -fr distribution asciidoctor.css index.html README.html
  if ! git checkout gh-pages; then
    echo Could not switch to gh-pages branch; exit
  fi
fi

git reset --hard origin/gh-pages
#git pull -s recursive -X theirs

if test ! -d distribution; then
  echo No distribution directory found; exit
fi

DEPLOY_DIR=/gpfs/main/authen/sys/web/cs/web/sites/bootstrapworld.org/preview

ON_DEPLOY_SITE=1

if test ! -d $DEPLOY_DIR; then
  ON_DEPLOY_SITE=
  DEPLOY_DIR=~/tmp
  if test ! -d $DEPLOY_DIR; then
    mkdir $DEPLOY_DIR
  fi
fi

rm -fr $DEPLOY_DIR/distribution

cp -prH distribution $DEPLOY_DIR

if test "$ORIG_BRANCH" != gh-pages; then
  git checkout $ORIG_BRANCH
fi

cd $DEPLOY_DIR

find distribution -type d | xargs chmod g+rwx,o+rx

cd distribution

find . -type f | xargs chmod g+rw,o+r

cd ..

rm -fr curriculum

mv distribution curriculum

if test "$ON_DEPLOY_SITE"; then
  chgrp -R cs-plt curriculum
fi
