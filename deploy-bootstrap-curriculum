# last modified 2019-11-06

if ! git rev-parse --is-inside-work-tree; then
  echo Not in a Git repo; exit
fi

REPO_TOPDIR=$(git rev-parse --show-toplevel)

if test "$(basename $REPO_TOPDIR)" != curriculum; then
  echo Not in curriculum repo; exit
fi

cd $REPO_TOPDIR

ORIG_BRANCH=$(git rev-parse --abbrev-ref HEAD)

if test "$ORIG_BRANCH" != gh-pages; then
  rm -fr distribution asciidoctor.css index.html README.html
  if ! git checkout gh-pages; then
    echo Could not switch to gh-pages branch; exit
  fi
fi

git reset --hard origin/gh-pages
#git pull -s recursive -X theirs

if test ! -d distribution; then
  echo No distribution directory found; exit
fi

#if test ! "$YEAR"; then YEAR=2020; fi
#if test ! "$SEMESTER"; then SEMESTER=spring; fi

YEAR=2020
SEMESTER=spring

DEPLOY_DIR=/gpfs/main/authen/sys/web/cs/web/sites/bootstrapworld.org/materials/$SEMESTER$YEAR/courses

ON_DEPLOY_SITE=true

if test ! -d $DEPLOY_DIR; then
  ON_DEPLOY_SITE=false
  echo $DEPLOY_DIR not found -- using ~/tmp instead
  DEPLOY_DIR=~/tmp
  if test ! -d $DEPLOY_DIR; then
    mkdir $DEPLOY_DIR
  fi
fi

if $ON_DEPLOY_SITE; then
  find distribution -type d | xargs chmod g+rwx,o+rx
  find distribution -type f | xargs chmod g+rw,o+r
  chgrp -R cs-plt distribution
fi

for proglang in wescheme pyret; do
  rm -fr $DEPLOY_DIR/algebra-$proglang-remix
  rm -fr $DEPLOY_DIR/buggy-recipes-$proglang
  cp -prH distribution/bs-game-pathway-$proglang $DEPLOY_DIR/algebra-$proglang-remix
  cp -prH distribution/buggy-recipes-$proglang $DEPLOY_DIR
done

if test "$ORIG_BRANCH" != gh-pages; then
  git checkout $ORIG_BRANCH
fi
