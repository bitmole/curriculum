# last modified 2020-05-12

userid=$1

if test ! $userid; then
  echo Supply userid as arg! ; exit
fi

pwy=

if test $# -ge 2; then
  pwy=$2
fi

if test ! -d distribution; then
  echo distribution/ not found; exit
fi

cd distribution

test -d courses && rm -fr courses

mkdir courses

function copyCourse() {
  local src=$1
  test -d $src || return
  local dest=$(pathwayNameOnServer $src)
  cp -pr $src courses/$dest
}

function pathwayNameOnServer() {
  local localName=$1
  case $localName in
    game-pathway-wescheme) echo algebra-wescheme;;
    game-pathway-pyret) echo algebra-pyret;;
    data-science-pathway) echo data-science;;
    reactive-pathway) echo reactive;;
    flags-pathway) echo flags;;
    *) echo $1;;
  esac
}

if test $pwy; then
  copyCourse $pwy
else
  copyCourse game-pathway-wescheme
  copyCourse game-pathway-pyret
  copyCourse data-science-pathway
  copyCourse reactive-pathway
  copyCourse flags-pathway
fi

for f in asc asciidoc rkt.kp txt.kp; do
  find courses -name \*.$f -delete
done

test -f courses.tar.bz2 && rm courses.tar.bz2

echo Tarring up courses...
tar jcf courses.tar.bz2 courses

#exit

echo Copying courses tarball to brown.edu...
scp courses.tar.bz2 $userid@ssh.cs.brown.edu:tmp/.

success=$?

if test "$success" -ne 0; then
  echo SCP failed! ; exit
fi

echo Copying done

cd ..

./deploy-to-brown-perms $userid

