# last modified 2020-05-16

# Set environment variables SEMESTER and YEAR to reflect where you want the
# curriculum pages to be deployed on the server.

SEMESTER=fall
YEAR=2020

############################################################################

userid=$1

if test ! $userid; then
  echo Supply userid as arg! ; exit
fi

pwy=

if test $# -ge 2; then
  pwy=$2
fi

if test ! -d distribution; then
  echo distribution/ not found; exit
fi

cd distribution

test -d courses && rm -fr courses

mkdir courses

SEMESTER_YEAR=$SEMESTER$YEAR

SED=sed

if which gsed | grep -q .; then
  SED=gsed
fi

function correctgdriveurl_1() {
  local f=$1
  $SED -i -e '/href=/s/\(spring\|fall\)[0-9][0-9][0-9][0-9]/'$SEMESTER_YEAR'/g' $f
}

function correctgdriveurls() {
  local d=$1
  for f in $(find $d -name \*gdrive-import.shtml); do
    correctgdriveurl_1 $f
  done
}

function copyCourse() {
  local src=$1
  test -d $src || return
  local dest=$(pathwayNameOnServer $src)
  cp -pr $src courses/$dest
  correctgdriveurls courses/$dest
}

function pathwayNameOnServer() {
  local localName=$1
  case $localName in
    game-pathway-wescheme) echo algebra-wescheme;;
    game-pathway-pyret) echo algebra-pyret;;
    data-science-pathway) echo data-science;;
    reactive-pathway) echo reactive;;
    flags-pathway) echo flags;;
    *) echo $1;;
  esac
}

if test $pwy; then
  copyCourse $pwy
else
  copyCourse game-pathway-wescheme
  copyCourse game-pathway-pyret
  copyCourse data-science-pathway
  copyCourse reactive-pathway
  copyCourse flags-pathway
fi

for f in asc asciidoc rkt.kp txt.kp DS_Store; do
  find courses -name \*.$f -delete
done

find courses -name workbook-[A-Z]\*.pdf -delete
find courses -name workbook-sols-\*.pdf -delete
find courses -name pd-workbook-\*.pdf -delete

test -f courses.tar.bz2 && rm courses.tar.bz2

echo Tarring up courses...
tar jcf courses.tar.bz2 courses

echo Copying courses tarball to brown.edu...
scp courses.tar.bz2 $userid@ssh.cs.brown.edu:tmp/.

success=$?

if test "$success" -ne 0; then
  echo SCP failed! ; exit
fi

echo Copying done

cd ..

SEMESTER_YEAR=$SEMESTER_YEAR ./deploy-to-brown-perms $userid

