# last modified 2020-06-01

# Set environment variables SEMESTER and YEAR to reflect where you want the
# curriculum pages to be deployed on the server.

SEMESTER=fall
YEAR=2020

############################################################################

userid=$1

if test ! $userid; then
  echo Supply userid as arg! ; exit
fi

pwy=

if test $# -ge 2; then
  pwy=$2
fi

if test ! -d distribution; then
  echo distribution/ not found; exit
fi

cd distribution

test -d deployables && rm -fr deployables

mkdir deployables

ALL_THE_LANGS="en-us es-mx"

for lang in $ALL_THE_LANGS; do
  mkdir -p deployables/$lang/courses
done

SEMESTER_YEAR=$SEMESTER$YEAR

SED=sed

(which gsed | grep -q .) && SED=gsed

function correctgdriveurl_1() {
  local f=$1
  $SED -i -e '/href=/s/\(spring\|fall\)[0-9][0-9][0-9][0-9]/'$SEMESTER_YEAR'/g' $f
}

function correctgdriveurls() {
  local d=$1
  for f in $(find $d -name \*gdrive-import.shtml); do
    correctgdriveurl_1 $f
  done
}

function copyCourse() {
  for lang in $ALL_THE_LANGS; do
    local dir=$1
    test -d $lang/courses/$dir || return
    cp -pr $lang/courses/$dir deployables/$lang/courses/$dir
    correctgdriveurls deployables/$lang/courses/$dir
  done
}

for lang in $ALL_THE_LANGS; do
  for f in $lang/*; do
    if test -f $f; then
      cp -p $f deployables/$lang
    fi
  done
done

if test $pwy; then
  copyCourse $pwy
else
  copyCourse algebra-wescheme
  copyCourse algebra-pyret
  copyCourse data-science
  copyCourse reactive
  copyCourse flags
fi

for f in asc asciidoc rkt.kp txt.kp DS_Store; do
  find deployables -name \*.$f -delete
done

find deployables -name workbook-[A-Z]\*.pdf -delete
find deployables -name workbook-sols-\*.pdf -delete
find deployables -name pd-workbook-\*.pdf -delete

test -f deployables.tar.bz2 && rm deployables.tar.bz2

echo Tarring up deployables...
tar jcf deployables.tar.bz2 deployables

echo Copying courses tarball to brown.edu...
scp deployables.tar.bz2 $userid@ssh.cs.brown.edu:tmp/.

success=$?

if test "$success" -ne 0; then
  echo SCP failed! ; exit
fi

echo Copying done

rm -fr deployables

cd ..

SEMESTER_YEAR=$SEMESTER_YEAR ./deploy-to-brown-perms $userid

