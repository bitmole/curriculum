# last modified 2019-09-20

if test README.html -ot README.adoc; then
  asciidoctor -a linkcss README.adoc
fi

echo '== Generated Documentation' > index.adoc
echo >> index.adoc
echo link:README.html[Authoring Guide] >> index.adoc
echo >> index.adoc
echo https://github.com/bootstrapworld/curriculum[\`curriculum\` Repo] >> index.adoc

export SED=sed

if test $(which gsed|wc -l) -ne 0; then
  SED=gsed
fi

export TOPDIR=$(pwd)

if test ! -d distribution; then
  mkdir distribution
fi

cd distribution

echo '== Generated Documentation' > index.adoc

cd $TOPDIR

export LANGUAGE=en-us
export PROGLANG=

export DEBUG=
export NOPDF=
unset NOPDF

ARGS=
while test $# -ne 0; do
  arg=$1; shift
  if test x$arg = x--language; then
    LANGUAGE=$1; shift
  elif test x$arg = x--proglang; then
    PROGLANG=$1; shift
  elif test x$arg = x--debug; then
    DEBUG=1;
  elif test x$arg = x--nopdf; then
    NOPDF=1;
  else
    ARGS="$ARGS $arg"
  fi
done

if test "$ARGS" = ""; then
  ARGS="pathways/*"
fi

if test ! -d prog; then
  mkdir prog
fi

PROGDIR=$TOPDIR/prog

cp -p $TOPDIR/lib/* $TOPDIR/lib/.hta* $PROGDIR

# just in case shared/langs/$LANGUAGE isn't sufficiently populated
cp -p $TOPDIR/shared/langs/en-us/* $PROGDIR

if test -d $TOPDIR/shared/langs/$LANGUAGE; then
  cp -p $TOPDIR/shared/langs/$LANGUAGE/* $PROGDIR
fi

#cp -p $TOPDIR/lib/.htp* distribution

insertbodyid() {
  f=$1
  $SED -i \
    -e 's/<body[^>]*>/\0\n<div id="body">/' \
    -e 's/<\/body>/<\/div>\n\0/' \
    $f
}

insertstylecss() {
  f=$1
  $SED -i \
    -e 's/<link.*curriculum.css/<link rel="stylesheet" href="\/styles.css">\n\0/' \
    $f
}

resolvespans() {
  f=$1
  $SED -i \
    -e 's/@PYRETKEYWORD\([^@]*\)@END/<span class=pyretkeyword>\1<\/span>/g' \
    -e 's/<p>\(@CURRICULUMCOMMENT\)/\1/' \
    -e 's/\(@ENDCURRICULUMCOMMENT\)<.p>/\1/' \
    -e 's/@CURRICULUMCOMMENT/<!-- /' \
    -e 's/@ENDCURRICULUMCOMMENT/\n-->/' \
    -e 's/@CURRICULUMSPAN/<span /g' \
    -e 's/@BEGINCURRICULUMSPAN/>/g' \
    -e 's/@ENDCURRICULUMSPAN/<\/span>/g' \
    $f
  tif=${f%.html}-comment.txt
  if test -f $tif; then
    $SED -i \
      -e '/^<body[^>]*>/s/<body[^>]*>/\0INSERTCURRICULUMCOMMENT/' \
      -e '/INSERTCURRICULUMCOMMENT/r '$tif \
      -e 's/INSERTCURRICULUMCOMMENT//' \
      $f
  fi
}

buildworkbookpages() {
  L=$1
  echo
  echo building $L workbook-pages
  cd $L
  #
  if test -d workbook-pages/$PROGLANG; then
    cp -p workbook-pages/$PROGLANG/* workbook-pages
  fi
  #
  cp -pr workbook-pages solutions-pages
  if test -d workbook-sols-pages; then
    for f in workbook-sols-pages/*; do
      if test -f $f; then
        cp -p $f solutions-pages
      fi
    done
    if test -d workbook-sols-pages/$PROGLANG; then
      cp -p workbook-sols-pages/$PROGLANG/* solutions-pages
    fi
    rm -fr workbook-sols-pages
  fi
  mv solutions-pages workbook-sols-pages
  #
  if test -d exercises; then
    if test -d exercises/$PROGLANG; then
      cp -p exercises/$PROGLANG/* exercises
    fi
    cp -pr exercises exercises-sols
  fi
  #
  for d in exercises exercises-sols workbook-pages workbook-sols-pages; do
    if test -d $d; then
      echo \(building $d\)
      unset EXERCISE SOLUTIONS WORKBOOK
      if test $d = "workbook-sols-pages" -o $d = "exercises-sols"; then
        export SOLUTIONS=1
      elif test $d = "workbook-pages"; then
        export WORKBOOK=1
      elif test $d = "exercises"; then
        export EXERCISE=1
      fi
      cd $d
      export PATHWAYROOTDIR="../../../"
      cp -p $PROGDIR/*.css .
      for f in *.adoc; do
        if test ! -f $f; then
          echo "        " No adoc files in lesson $L/$d
        else
          echo building $f
          $PROGDIR/adoc-preproc.rkt $f
          fhtml=${f%.adoc}.html
          fpdf=${f%.adoc}.pdf
          resolvespans $fhtml
          if test -z $NOPDF; then
            wkhtmltopdf --lowquality --print-media-type -q $fhtml $fpdf
          fi
        fi
      done
      unset EXERCISE SOLUTIONS WORKBOOK
      cd ..
    fi
  done
  cd ..
}

buildlessonplan() {
  echo doing buildlessonplan
  L=$1
  echo
  echo building $L lesson plan
  cd $L
  copacetic=1
  for f in *.adoc; do
    if test ! -f $f; then
      copacetic=0
    fi
  done
  if test x$copacetic = x0; then
    echo WARNING: No lesson plan in lesson $L
  elif test $(ls *.adoc|wc -l) -gt 1; then
    echo WARNING: Too many lesson plans in lesson $L
  else
    cp -p $PROGDIR/*.css .
    export PATHWAYROOTDIR="../../"
    # there should be only one?
    echo building lesson plan from *.adoc
    $PROGDIR/adoc-preproc.rkt *.adoc
    if test ! -f index.html; then
      SRCFILE=
      for g in *.adoc; do
        SRCFILE=${g%.adoc}
        cp -p $SRCFILE.asc index.asc
        cp -p $SRCFILE.html index.html
      done
      if test -n "$SRCFILE"; then
        rm $SRCFILE.html $SRCFILE.asc
      fi
    fi
    resolvespans index.html
    if test -z $NOPDF; then
      echo Creating lesson plan pdf
      wkhtmltopdf --lowquality --print-media-type -q index.html index.pdf
    fi
  fi
  cd ..
}

buildlessons() {
  echo doing buildlessons
  cd lessons
  for L in *; do
    if test ! -d $L; then
      echo WARNING: No lessons in pathway $PATHWAY
    else
      export LESSON=$L
      buildworkbookpages $L
      export LESSONPLAN=$L
      buildlessonplan $L
      unset LESSONPLAN
      unset LESSON
    fi
  done
  cd ..
}

buildpathway() {
  cd $TOPDIR

  PATHWAY=$SRCPATHWAY

  # special-casing only algebra and bs-game-pathway,
  # as they're the only pathways that allow two prog langs
  if test "$SRCPATHWAY" = bs-game-pathway -o "$SRCPATHWAY" = algebra; then
    PATHWAY=$SRCPATHWAY-$PROGLANG
  elif test "$PROGLANG" = wescheme; then
    PATHWAY=$SRCPATHWAY-wescheme
  fi

  if test ! -d distribution/$PATHWAY; then
    mkdir distribution/$PATHWAY
  fi
  # remove previous build of $PATHWAY in distribution/, if any
  if test -d distribution/$PATHWAY/$LANGUAGE; then
    rm -fr distribution/$PATHWAY/$LANGUAGE
  fi
  cp -pr pathways/$SRCPATHWAY/langs/$LANGUAGE distribution/$PATHWAY/$LANGUAGE

  echo

  if test ! -d distribution/$PATHWAY/$LANGUAGE; then
    echo WARNING: No pathway $PATHWAY/$LANGUAGE
  else
    echo building pathway: $PATHWAY/$LANGUAGE
    cd distribution/$PATHWAY/$LANGUAGE

    mkdir lessons workbook
    mkdir -p resources/protected
    cp -p $PROGDIR/.hta* resources/protected

    if test ! -f workbook-index.rkt; then
      echo WARNING: No workbook-index.rkt in pathway $PATHWAY/$LANGUAGE
    else
      $PROGDIR/copy-lessons.rkt
    fi

    buildlessons
    echo

    cd resources
    cp -p $PROGDIR/*.css $PROGDIR/.hta* .
    copacetic=1
    for f in *.adoc; do
      if test ! -f $f; then copacetic=0
      fi
    done
    if test x$copacetic = x0; then
      echo WARNING: No teacher resource files in pathway $PATHWAY
    elif test $(ls *.adoc|wc -l) -gt 1; then
      echo WARNING: Too many teacher resource files in pathway $PATHWAY
    else
      export PATHWAYROOTDIR="../"
      # there should be only one?
      echo building teacher resource doc from *.adoc
      export TEACHER_RESOURCES=1
      $PROGDIR/adoc-preproc.rkt *.adoc
      unset TEACHER_RESOURCES
      if test ! -f index.html; then
        SRCFILE=
        for g in *.adoc; do
          SRCFILE=${g%.adoc}
          cp -p $SRCFILE.asc index.asc
          cp -p $SRCFILE.html index.html
        done
        if test -n "$SRCFILE"; then
          rm $SRCFILE.html $SRCFILE.asc
        fi
      fi
      resolvespans index.html
    fi
    cd ..

    if test ! -f workbook-page-index.rkt; then
      echo WARNING: No workbook index file in pathway $PATHWAY/$LANGUAGE
    else
      export PATHWAYROOTDIR=""
      cp -p $PROGDIR/front-cover-teacher.pdf .
      $PROGDIR/make-workbook.rkt
      rm -f workbook-numbered.* front-cover-teacher.pdf
    fi

    copacetic=1
    for f in *.adoc; do
      if test ! -f $f; then copacetic=0
      fi
    done
    if test x$copacetic = x0; then
      echo WARNING: No narrative in pathway $PATHWAY
    elif test $(ls *.adoc|wc -l) -gt 1; then
      echo WARNING: Too many narratives in pathway $PATHWAY
    else
      cp -p $PROGDIR/*.css .
      export PATHWAYROOTDIR=""
      export NARRATIVE=1
      # there should be only one?
      echo building pathway narrative from *.adoc
      $PROGDIR/adoc-preproc.rkt *.adoc
      unset NARRATIVE
      if test ! -f index.html; then
        SRCFILE=
        for g in *.adoc; do
          SRCFILE=${g%.adoc}
          cp -p $SRCFILE.asc index.asc
          cp -p $SRCFILE.html index.html
        done
        if test -n "$SRCFILE"; then
          rm $SRCFILE.html $SRCFILE.asc
        fi
      fi
      insertbodyid index.html
      insertstylecss index.html
      resolvespans index.html
    fi

  fi

  cd $TOPDIR

}

for f in $ARGS; do
  export SRCPATHWAY=$f
  export SRCPATHWAY=${SRCPATHWAY#pathways/}
  export SRCPATHWAY=${SRCPATHWAY%/}
  if test "$PROGLANG" = ""; then
    if test "$SRCPATHWAY" = bs-game-pathway -o "$SRCPATHWAY" = algebra; then
      export PROGLANG=wescheme; buildpathway
    fi
    export PROGLANG=pyret
    buildpathway
    unset PROGLANG
  else
    buildpathway
  fi
done

rm -fr $PROGDIR

echo >> index.adoc
echo .{nbsp} >> index.adoc

for f in distribution/*/*; do
  f=${f%/}
  g=${f#distribution/}
  pwy=${g%/*}
  lang=${g#*/}
  docf=$f/index.html
  if test -f $docf; then
    echo >> index.adoc
    echo \* link:$docf[$pwy Narrative \($lang\)] >> index.adoc
  fi
done

asciidoctor -a linkcss index.adoc

cd distribution

echo >> index.adoc
echo .{nbsp} >> index.adoc

for f in */*; do
  f=${f%/}
  pwy=${f%/*}
  lang=${f#*/}
  docf=$f/index.html
  if test -f $docf; then
    echo >> index.adoc
    echo \* link:$docf[$pwy Narrative \($lang\)] >> index.adoc
  fi
done

asciidoctor -a linkcss index.adoc

if test -z $DEBUG; then
  for f in adoc asc rkt title txt; do
    find . -name \*.$f -delete
  done
fi
