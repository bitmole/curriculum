# last modified 2019-08-01

if test README.html -ot README.adoc; then
  asciidoctor -a linkcss README.adoc
fi

echo '== Generated Documentation' > index.adoc
echo >> index.adoc
echo link:README.html[Authoring Guide] >> index.adoc
echo >> index.adoc
echo https://github.com/bootstrapworld/curriculum[\`curriculum\` Repo] >> index.adoc

export LANGUAGE=en-us

if test $# -eq 0
then args="pathways/*"
else
  args=
  while test $# -ne 0; do
    arg=$1; shift
    if test x$arg = x--language; then
      LANGUAGE=$1; shift
    else
      args="$args $arg"
    fi
  done
fi

export TOPDIR=$(pwd)

if test ! -d prog; then
  mkdir prog
fi

PROGDIR=$TOPDIR/prog

#cp -p $TOPDIR/lib/* $PROGDIR

# just in case shared/langs/$LANGUAGE isn't sufficiently populated
cp -p $TOPDIR/shared/langs/en-us/* $PROGDIR

cp -p $TOPDIR/shared/langs/$LANGUAGE/* $PROGDIR

cp -p $TOPDIR/lib/* $PROGDIR

if test ! -d distribution; then
  mkdir distribution
fi

buildworkbookpages() {
  L=$1
  echo
  echo building $L workbook-pages
  cd $L
  cp -pr workbook-pages solutions-pages
  if test -d exercises; then
    cp -pr exercises exercises-sols
  fi
  for f in workbook-sols-pages/*; do
    if test -f $f; then
      cp -p $f solutions-pages
    fi
  done
  rm -fr workbook-sols-pages
  mv solutions-pages workbook-sols-pages
  for d in exercises exercises-sols workbook-pages workbook-sols-pages; do
    if test -d $d; then
      echo \(building $d\)
      unset SOLUTIONS
      if test $d = "workbook-sols-pages" -o $d = "exercises-sols"; then
        export SOLUTIONS=1
      fi
      cd $d
      export PATHWAYROOTDIR="../../../"
      cp -p $PROGDIR/*.css .
      for f in *.adoc; do
        if test ! -f $f; then
          echo "        " No adoc files in lesson $L/$d
        else
          echo building $f
          $PROGDIR/adoc-preproc.rkt $f
          fhtml=${f%.adoc}.html
          fpdf=${f%.adoc}.pdf
          wkhtmltopdf --lowquality --print-media-type -q $fhtml $fpdf
        fi
      done
      unset SOLUTIONS
      cd ..
    fi
  done
  cd ..
}

buildlessonplan() {
  echo doing buildlessonplan
  L=$1
  echo
  echo building $L lesson plan
  cd $L
  copacetic=1
  for f in *.adoc; do
    if test ! -f $f; then
      copacetic=0
    fi
  done
  if test x$copacetic = x0; then
    echo WARNING: No lesson plan in lesson $L
  else
    cp -p $PROGDIR/*.css .
    export PATHWAYROOTDIR="../../"
    # there should be only one?
    echo building lesson plan from *.adoc
    $PROGDIR/adoc-preproc.rkt *.adoc
    if test ! -f index.html; then
      SRCFILE=
      for g in *.adoc; do
        SRCFILE=${g%.adoc}
        cp -p $SRCFILE.asc index.asc
        cp -p $SRCFILE.html index.html
      done
      if test -n "$SRCFILE"; then
        rm $SRCFILE.html $SRCFILE.asc
      fi
    fi
    echo Creating lesson plan pdf
    wkhtmltopdf --lowquality --print-media-type -q index.html index.pdf
  fi
  cd ..
}

buildlessons() {
  echo doing buildlessons
  cd lessons
  for L in *; do
    if test ! -d $L; then
      echo WARNING: No lessons in pathway $PATHWAY
    else
      export LESSON=$L
      buildworkbookpages $L
      export LESSONPLAN=$L
      buildlessonplan $L
      unset LESSONPLAN
      unset LESSON
    fi
  done
  cd ..
}

buildpathway() {
  cd $TOPDIR

  PATHWAY=$1

  PATHWAY=${PATHWAY#pathways/}

  PATHWAY=${PATHWAY%/}

  # remove previous build of $PATHWAY in distribution/, if any
  if test -d distribution/$PATHWAY; then
    rm -fr distribution/$PATHWAY
  fi
  cp -pr pathways/$PATHWAY distribution

  echo
  echo building pathway: $PATHWAY

  if test ! -d distribution/$PATHWAY; then
    echo WARNING: No pathway $PATHWAY
  elif test ! -d distribution/$PATHWAY/langs/$LANGUAGE; then
    echo WARNING: No files in pathway $PATHWAY
  else
    cd distribution/$PATHWAY/langs/$LANGUAGE

    mkdir lessons workbook
    mkdir -p resources/protected

    if test ! -f workbook-index.rkt; then
      echo WARNING: No workbook-index.rkt in pathway $PATHWAY
    else
      echo calling copy-lessons.rkt
      $PROGDIR/copy-lessons.rkt
    fi

    buildlessons
    echo

    cd resources
    cp -p $PROGDIR/*.css .
    copacetic=1
    for f in *.adoc; do
      if test ! -f $f; then copacetic=0
      fi
    done
    if test x$copacetic = x0; then
      echo WARNING: No teacher resource files in pathway $PATHWAY
    else
      export PATHWAYROOTDIR="../"
      export TEACHER_RESOURCES=1
      $PROGDIR/adoc-preproc.rkt *.adoc
      unset TEACHER_RESOURCES
      if test ! -f index.html; then
        SRCFILE=
        for g in *.adoc; do
          SRCFILE=${g%.adoc}
          cp -p $SRCFILE.asc index.asc
          cp -p $SRCFILE.html index.html
        done
        if test -n "$SRCFILE"; then
          rm $SRCFILE.html $SRCFILE.asc
        fi
      fi
    fi
    cd ..

    if test ! -f workbook-page-index.rkt; then
      echo WARNING: No workbook index file in pathway $PATHWAY
    else
      export PATHWAYROOTDIR=""
      cp -p $PROGDIR/front-cover-teacher.pdf $PROGDIR/BSABigIdeas.pdf .
      $PROGDIR/make-workbook.rkt
      rm -f workbook-numbered.* front-cover-teacher.pdf BSABigIdeas.pdf
    fi

    copacetic=1
    for f in *.adoc; do
      if test ! -f $f; then copacetic=0
      fi
    done
    if test x$copacetic = x0; then
      echo WARNING: No narrative in pathway $PATHWAY
    else
      cp -p $PROGDIR/*.css .
      export PATHWAYROOTDIR=""
      export NARRATIVE=1
      # there should be only one?
      echo building pathway narrative from *.adoc
      $PROGDIR/adoc-preproc.rkt *.adoc
      unset NARRATIVE
      if test ! -f index.html; then
        SRCFILE=
        for g in *.adoc; do
          SRCFILE=${g%.adoc}
          cp -p $SRCFILE.asc index.asc
          cp -p $SRCFILE.html index.html
        done
        if test -n "$SRCFILE"; then
          rm $SRCFILE.html $SRCFILE.asc
        fi
      fi
    fi

  fi

  cd $TOPDIR

}

for f in $args; do
  buildpathway $f
done

rm -fr prog

for f in distribution/*; do
  echo >> index.adoc
  docf=$f/langs/$LANGUAGE/index.html
  if test -f $docf; then
    echo \* link:$docf[$f Narrative] >> index.adoc
  fi
done

asciidoctor -a linkcss index.adoc
